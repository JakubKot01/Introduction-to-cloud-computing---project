<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Expenses Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div id="container">
        <header>
            <h1>Smart Expenses Tracker</h1>
            <nav>
                <ul>
                    <li><a href="/" class="header-btn">Expenses</a></li>
                    <li><a href="/stats" class="header-btn">Statistics</a></li>
                    <li><button id="addExpenseButton" class="header-btn">Add Expense</button></li>
                    <li><button id="addCategoryButton" class="header-btn">Add Category</button></li>
                </ul>
            </nav>
        </header>
        <main>
            <h2>Expenses list</h2>
            <table class="expenses-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>
                            <label for="category-filter">Category:</label>
                            <select id="category-filter">
                                <option value="all">All</option>
                                {% for category in categories %}
                                <option value="{{ category }}">{{ category }}</option>
                                {% endfor %}
                            </select>
                        </th>
                        <th>
                            Periodicity
                            <select id="periodicity-filter" class="filter-select">
                                <option value="all">All</option>
                                {% for periodicity in periodicity_list %}
                                <option value="{{ periodicity }}">{{ periodicity }}</option>
                                {% endfor %}
                            </select>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for expense in expenses %}
                    <tr data-category="{{ expense.category }}" data-periodicity="{{ expense.periodicity }}">
                        <td>{{ expense.name }}</td>
                        <td>{{ expense.date }}</td>
                        <td>{{ expense.amount }}</td>
                        <td>{{ expense.category }}</td>
                        <td>{{ expense.periodicity }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Modals -->
            <!-- Add Category Modal-->
            <div class="modal fade" id="addCategoryModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document" style="z-index: 1200;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="categoryModalLabel">Add Category</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="addCategoryForm">
                                <div class="form-group">
                                    <label for="categoryName">Category Name:</label>
                                    <input type="text" class="form-control" id="categoryName" name="categoryName" required>
                                </div>
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary" id="saveCategoryButton">Save</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Expense Modal -->
            <div class="modal fade" id="addExpenseModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document" style="z-index: 1200;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="expenseModalLabel">Add Expense</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="addExpenseForm" method="POST" action="/add_expense">
                                <div class="form-group">
                                    <label for="expenseName">Name:</label>
                                    <input type="text" class="form-control" id="expenseName" name="expenseName" required>
                                </div>
                                <div class="form-group">
                                    <label for="expenseDate">Date:</label>
                                    <input type="date" class="form-control" id="expenseDate" name="expenseDate" lang="en" required>
                                </div>
                                <div class="form-group">
                                    <label for="expenseAmount">Amount:</label>
                                    <input type="number" class="form-control" id="expenseAmount" name="expenseAmount" required>
                                </div>
                                <div class="form-group">
                                    <label for="expenseCategory">Category:</label>
                                    <select class="form-control" id="expenseCategory" name="expenseCategory" required>
                                        <option value="">Choose Category</option>
                                        {% for category in categories %}
                                        <option value="{{ category }}">{{ category }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="expensePeriodicity">Periodicity:</label>
                                    <select class="form-control" id="expensePeriodicity" name="expensePeriodicity" required>
                                        <option value="">Choose Periodicity</option>
                                        {% for periodicity in periodicity_list %}
                                        <option value="{{ periodicity }}">{{ periodicity }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary" id="saveExpenseButton">Save</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <footer>
            <p>&copy; 2024 Smart Expenses Tracker</p>
        </footer>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        $(document).ready(function(){
            $("#addCategoryButton").click(function(){
                $("#addCategoryModal").modal('show');
            });

            $("#saveCategoryButton").click(function(){
                var categoryName = $("#categoryName").val();
                $.post("/add_category", {
                    categoryName: categoryName
                }).done(function(response) {

                    // After successful adding the category, add to list and clean the text field

                    $("#category-filter").append('<option value="' + categoryName + '">' + categoryName + '</option>');
                    $("#categoryName").val('');
                    $("#addCategoryModal").modal('hide');
                    location.reload(true);
                }).fail(function(xhr, status, error) {

                    // Errors to handle

                    console.error(xhr.responseText);
                });
            });
        });

    </script>

    <script>
        $(document).ready(function(){
            $("#addExpenseButton").click(function(){
                $("#addExpenseModal").modal('show');
            });

            $("#saveExpenseButton").click(function(){
                $(this).prop('disabled', true);
                var expenseName = $("#expenseName").val();
                var expenseDate = $("#expenseDate").val();
                var expenseAmount = $("#expenseAmount").val();
                var expenseCategory = $("#expenseCategory").val();
                var expensePeriodicity = $("#expensePeriodicity").val();

                // Sending data to server via POST
                $.post("/add_expense", {
                    expenseName: expenseName,
                    expenseDate: expenseDate,
                    expenseAmount: expenseAmount,
                    expenseCategory: expenseCategory,
                    expensePeriodicity: expensePeriodicity
                }).done(function(response) {
                    $("#addExpenseModal").modal('hide');
                    location.reload(true);
                }).fail(function(xhr, status, error) {
                    // Obsłuż ewentualne błędy
                    console.error(xhr.responseText);
                }).always(function() {
                    $("#saveExpenseButton").prop('disabled', false);
                });
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var categoryFilter = document.getElementById('category-filter');
            var periodicityFilter = document.getElementById('periodicity-filter');

            function filterExpenses() {
                var selectedCategory = categoryFilter.value;
                var selectedPeriodicity = periodicityFilter.value;
                var rows = document.querySelectorAll('.expenses-table tbody tr');
                rows.forEach(function (row) {
                    var rowCategory = row.getAttribute('data-category');
                    var rowPeriodicity = row.getAttribute('data-periodicity');
                    if ((selectedCategory === 'all' || rowCategory === selectedCategory) &&
                        (selectedPeriodicity === 'all' || rowPeriodicity === selectedPeriodicity)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            // Call filterExpenses after filters values change
            categoryFilter.addEventListener('change', filterExpenses);
            periodicityFilter.addEventListener('change', filterExpenses);

            // Filter initialization
            filterExpenses();
        });
    </script>

    <script>
        $(document).ready(function(){
            // expenseName value change handler
            var expenseName;
            var typingTimer;
            var doneTypingInterval = 1000; // Category prediction delay

            $("#expenseName").on('input', function() {
                clearTimeout(typingTimer);
                typingTimer = setTimeout(doneTyping, doneTypingInterval);
                expenseName = $(this).val();
            });

            function doneTyping() {

                // Sending expenseName for category prediction
                $.ajax({
                    type: "POST",
                    url: "/suggest_category",
                    data: { expenseName: expenseName },
                    success: function(response) {
                        console.log(response)
                        let suggestedCategory = response.suggested_category;
                        $("#expenseCategory").val(suggestedCategory);
                    },
                    error: function(xhr, status, error) {
                        console.error(xhr.responseText);
                    }
                });
            }
        });
    </script>
</body>
</html>
